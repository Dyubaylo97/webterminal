<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="js/app.js" application="/csp/zitro/" default="1"><![CDATA[
/**
 * Basic application scripts.
 *
 * Required:
 *  base.js
 *  terminal.js
 *
 * @author ZitRo
 *
 *  TODO:
 *      - A tons of features todo :)
 */

var webSocket = null, // socket to exchange data with server
    commandHistory = [""], // history of all submitted commands
    historyCurrent = 0; // current position in this history

var lastCommandId = -1; // Every command has it's own id. It can be used to change logs, etc.

var handleInput = 0, // while true, function terminalHandledInput(data) will be called.
    tempStack = ""; // variable for all temp queries within handle

/**
 * Function initializing basic application components, like events, etc.
 *
 * @param authKey
 *  Default server-given parameter to access WebSocket application. 
 */
function terminalInitialize(authKey) {

    terminalFocusOnInput();
    for (var i = 0; i < 256; i++) keyPressed[i] = 0; // initializing keys
    bindEvent( document, "keydown", bodyKeyDown );
    bindEvent( document, "keyup", bodyKeyUp );
    bindEvent( document, "keydown", terminalGlobalKeyDown );
    bindEvent( terminalGetInputObject(), "blur", clearKeyStates );
    addTextareasAutoresize();
    if (!ie()) setInterval("terminalCaretTick()",500);
    terminalSetCommandZone("server");
    terminalUpdateInputView();
    terminalOutput("Terminal base ready. Type " +
        "<span class=\"warning\">/help</span> to get more information.", 0, "<b>system</b>");
    terminalServerConnect(document.URL.replace(/(\.CSP|\.csp)/,".Engine.cls").replace(/http:\/\//,"ws://"),authKey);
    removeElement(document.getElementById("startup")); // remove forever any information about authKey on pages

}

/**
 * Connects machine to server, add handlers, etc.
 *
 * @param server
 *  URL or pair IP:PORT of server to connect to.
 *
 * @param authKey
 *  Authorization parameter.
 */
function terminalServerConnect(server, authKey) {

    var error = 0, url = (server.substr(0,5)=="ws://")?server:("ws://"+server+"/csp/sys/WebTerminal.Engine.cls");

    if (webSocket != null) {
        terminalOutput("Connection already established.", 0,"<span class=\"warning\">warning</span>");
        terminalInternalCommand_disconnect()
    }

    terminalOutput("Connecting <span class=\"info\">" + url + "</span>...", 0, "server");
    try {
        webSocket = new WebSocket(url);
    } catch (e) {
        error = 1;
    }

    if (error) {
        terminalOutput("Your browser does not support <b>WebSockets</b>. Please, update your browser.",
            0,"<span style=\"color: red\">warning</span>");
        return;
    }

    if (typeof webSocket == "undefined") {
        terminalOutput("There is a problem to create <b>WebSocket</b>. Please, check the URL and class location.",
            0,"<span style=\"color: red\">warning</span>");
    }

    webSocket.onopen = function() {
        terminalOutput("Connection established. Authorizing...", 0, "server");
        terminalExecute(authKey,ACTION_AUTHORIZATION);
    };

    webSocket.onclose = function(event) {

        webSocket = null;
        var t;
        if (event.wasClean) {
            t = "<span class=\"hint\">Connection closed.</span>"
        } else {
            t = "<span class=\"error\">Connection broken.</span>"
        }
        terminalOutput(t + " Code: " + event.code + ((event.reason)?"; reason: "+event.reason:"") );

    };

    webSocket.onmessage = function(event) { terminalMessageReceived(event) };

    webSocket.onerror = function(error) {
        terminalOutput("<span class=\"error\">error: " + error.message + "</span>",1,"server")
    };

}

/**
 * Function executes local script.
 *
 * @param string
 *  String to execute.
 */
function terminalInternalExecute(string) {

    var arguments = string.split(/\s*\s+\s*/g);
    var command = arguments.splice(0,1)[0];
    try {
        eval("terminalInternalCommand_"+command+"(arguments)");
    } catch (e) {
        terminalOutput("Unknown command \""+command+"\".",0,"<span class=\"warning\">system</span>")
    }

}

/**
 * Shows help.
 */
function terminalInternalCommand_help() {

    terminalOutput("<div class=\"center\"><h3>Caché Web Terminal</h3></div>" +
        "<table>" +
        "   <tr>" +
        "       <td class=\"hint\">Available commands</td>" +
        "       <td class=\"hint\">Description</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">help</td>" +
        "       <td>Shows help</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">connect [{ip}:{port} | {url}]</td>" +
        "       <td>[deprecated] Manually connect to Caché server via <b>WebSocket</b></td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">disconnect</td>" +
        "       <td>Disconnecting from current server</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">clear</td>" +
        "       <td>Clears terminal command log. Just a visual feature.</td>" +
        "   </tr>" +
        "</table>" +
        "<div class=\"center\"><h3>Controls</h3></div>" +
        "<table>" +
        "   <tr>" +
        "       <td class=\"hint\">Key</td>" +
        "       <td class=\"hint\">Description</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">TAB</td>" +
        "       <td>Ends current input with suggested autocomplete option</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">CTRL</td>" +
        "       <td>While few autocomplete option is present, changes variant of option to next available</td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">keys UP/DOWN</td>" +
        "       <td>Affords access to command history. <i>Current query will be saved.</i></td>" +
        "   </tr>" +
        "   <tr>" +
        "       <td class=\"info\">SHIFT/CTRL + ENTER</td>" +
        "       <td>Next line in current command stack.</td>" +
        "   </tr>"
        ,0,"<span class=\"warning\">system</span>")

}

function terminalInternalCommand_connect() {

    /*if (typeof arguments[0] == "undefined") {
        terminalOutput("Please enter server address.",0,"<span class=\"error\">system</span>")
    } else {
        terminalServerConnect(arguments[0],);
    }*/
    terminalOutput("Authorization key lost forever. Please, reload this page.",0,"<span class=\"error\">system</span>")

}

/**
 * Just clears all logs
 */
function terminalInternalCommand_clear() { terminalClearLog() }

function terminalInternalCommand_disconnect() {

    terminalOutput("Closing connection...",0,"<span class=\"warning\">system</span>");
    webSocket.close();
    webSocket = null;

}]]></CSP>
</Export>
